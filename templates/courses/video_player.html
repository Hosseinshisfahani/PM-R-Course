{% extends 'base.html' %}

{% block title %}{{ video.title }} - {{ course.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Video Player -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-0">
                    <div class="video-container">
                        <video id="videoPlayer" 
                               class="w-100" 
                               controls 
                               preload="metadata"
                               data-video-id="{{ video.id }}"
                               data-progress="{{ progress.watched_seconds|default:0 }}">
                            <source src="{{ video.video_file.url }}" type="video/mp4">
                            مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
                        </video>
                    </div>
                </div>
                <div class="card-body">
                    <h3 class="card-title">{{ video.title }}</h3>
                    {% if video.description %}
                        <p class="card-text">{{ video.description }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Course Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ course.title }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">{{ course.short_description|truncatechars:100 }}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">{{ course.get_total_sections }} بخش</span>
                        <span class="text-muted">{{ course.duration_hours }} ساعت</span>
                    </div>
                </div>
            </div>
            
            <!-- Section Videos -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">{{ section.title }}</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for other_video in other_videos %}
                        <a href="{% url 'courses:video_player' course.slug section.id other_video.id %}" 
                           class="list-group-item list-group-item-action {% if other_video.id == video.id %}active{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-play-circle me-2 {% if other_video.id == video.id %}text-white{% else %}text-primary{% endif %}"></i>
                                    <div>
                                        <div class="fw-bold {% if other_video.id == video.id %}text-white{% endif %}">{{ other_video.title }}</div>
                                        {% if other_video.duration_seconds %}
                                            <small class="{% if other_video.id == video.id %}text-white-50{% else %}text-muted{% endif %}">
                                                {{ other_video.duration_seconds|floatformat:0 }} ثانیه
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if other_video.is_preview %}
                                    <span class="badge bg-success">پیش‌نمایش</span>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{% url 'courses:section_detail' course.slug section.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-2"></i>
                    بازگشت به بخش
                </a>
                <a href="{{ course.get_absolute_url }}" class="btn btn-outline-primary">
                    <i class="fas fa-book me-2"></i>
                    مشاهده دوره
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Video Progress Tracking Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('videoPlayer');
    const videoId = video.dataset.videoId;
    const initialProgress = parseInt(video.dataset.progress) || 0;
    
    // Set initial time
    if (initialProgress > 0) {
        video.currentTime = initialProgress;
    }
    
    // Track progress every 10 seconds
    let lastUpdate = 0;
    video.addEventListener('timeupdate', function() {
        const currentTime = Math.floor(video.currentTime);
        
        // Only update every 10 seconds to avoid too many requests
        if (currentTime - lastUpdate >= 10) {
            updateVideoProgress(videoId, currentTime);
            lastUpdate = currentTime;
        }
    });
    
    // Update progress when video ends
    video.addEventListener('ended', function() {
        updateVideoProgress(videoId, video.duration);
    });
    
    function updateVideoProgress(videoId, watchedSeconds) {
        fetch('{% url "courses:update_video_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                video_id: videoId,
                watched_seconds: watchedSeconds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Progress updated');
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
    }
});
</script>

<style>
.video-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
}

.video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
</style>
{% endblock %}


